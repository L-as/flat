<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><link rel="stylesheet" type="text/css" href="style.css" /><script type="text/javascript" src="highlight.js"></script></head><body><pre><span class="hs-pragma">{-# LANGUAGE ScopedTypeVariables #-}</span><span>
</span><a name="line-2"></a><span class="hs-pragma">{-# LANGUAGE FlexibleContexts #-}</span><span>
</span><a name="line-3"></a><span class="hs-pragma">{-# LANGUAGE Trustworthy ,NoMonomorphismRestriction#-}</span><span>
</span><a name="line-4"></a><span>
</span><a name="line-5"></a><span class="hs-comment">{- | Primitives to convert between Float\/Double and Word32\/Word64.

Code copied from &lt;https://hackage.haskell.org/package/binary binary&gt;.

Based on: &lt;http://hackage.haskell.org/package/reinterpret-cast-0.1.0/docs/src/Data-ReinterpretCast-Internal-ImplArray.html&gt;..

Implements casting via a 1-element STUArray, as described in &lt;http://stackoverflow.com/a/7002812/263061&gt;.
-}</span><span>
</span><a name="line-13"></a><span class="hs-keyword">module</span><span> </span><span class="hs-identifier">Data.FloatCast</span><span>
</span><a name="line-14"></a><span>  </span><span class="hs-special">(</span><span> </span><a href="Data.FloatCast.html#floatToWord"><span class="hs-identifier hs-var">floatToWord</span></a><span>
</span><a name="line-15"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Data.FloatCast.html#wordToFloat"><span class="hs-identifier hs-var">wordToFloat</span></a><span>
</span><a name="line-16"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Data.FloatCast.html#doubleToWord"><span class="hs-identifier hs-var">doubleToWord</span></a><span>
</span><a name="line-17"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Data.FloatCast.html#wordToDouble"><span class="hs-identifier hs-var">wordToDouble</span></a><span>
</span><a name="line-18"></a><span>  </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">runST</span><span>
</span><a name="line-19"></a><span>  </span><span class="hs-special">,</span><span> </span><a href="Data.FloatCast.html#cast"><span class="hs-identifier hs-var">cast</span></a><span>
</span><a name="line-20"></a><span>  </span><span class="hs-special">)</span><span>
</span><a name="line-21"></a><span class="hs-keyword">where</span><span>
</span><a name="line-22"></a><span>
</span><a name="line-23"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data.Word</span><span>                      </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-type">Word32</span><span>
</span><a name="line-24"></a><span>                                                </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">Word64</span><span>
</span><a name="line-25"></a><span>                                                </span><span class="hs-special">)</span><span>
</span><a name="line-26"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data.Array.ST</span><span>                  </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">newArray</span><span>
</span><a name="line-27"></a><span>                                                </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-var">readArray</span><span>
</span><a name="line-28"></a><span>                                                </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">MArray</span><span>
</span><a name="line-29"></a><span>                                                </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">STUArray</span><span>
</span><a name="line-30"></a><span>                                                </span><span class="hs-special">)</span><span>
</span><a name="line-31"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">Data.Array.Unsafe</span><span>              </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">castSTUArray</span><span> </span><span class="hs-special">)</span><span>
</span><a name="line-32"></a><span class="hs-keyword">import</span><span>           </span><span class="hs-identifier">GHC.ST</span><span>                         </span><span class="hs-special">(</span><span> </span><span class="hs-identifier hs-var">runST</span><span>
</span><a name="line-33"></a><span>                                                </span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">ST</span><span>
</span><a name="line-34"></a><span>                                                </span><span class="hs-special">)</span><span>
</span><a name="line-35"></a><span class="hs-comment">-- import           Flat.Endian</span><span>
</span><a name="line-36"></a><span>
</span><a name="line-37"></a><span>
</span><a name="line-38"></a><span>
</span><a name="line-39"></a><span class="hs-comment">-- | Reinterpret-casts a `Word32` to a `Float`.</span><span>
</span><a name="line-40"></a><span class="hs-comment">{-|
prop&gt; \f -&gt; wordToFloat (floatToWord f ) == f

&gt;&gt;&gt; floatToWord (-0.15625)
3189768192

&gt;&gt;&gt; wordToFloat 3189768192
-0.15625

&gt;&gt;&gt; floatToWord (-5.828125) == 0xC0BA8000
True
-}</span><span>
</span><a name="line-52"></a><span class="hs-identifier">wordToFloat</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Word32</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Float</span><span>
</span><a name="line-53"></a><a name="wordToFloat"><a href="Data.FloatCast.html#wordToFloat"><span class="hs-identifier">wordToFloat</span></a></a><span> </span><a name="local-6989586621679026077"><a href="#local-6989586621679026077"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">runST</span><span> </span><span class="hs-special">(</span><a href="Data.FloatCast.html#cast"><span class="hs-identifier hs-var">cast</span></a><span> </span><a href="#local-6989586621679026077"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">)</span><span>
</span><a name="line-54"></a><span class="hs-pragma">{-# INLINE</span><span> </span><span class="hs-pragma">wordToFloat</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-55"></a><span>
</span><a name="line-56"></a><span class="hs-comment">-- | Reinterpret-casts a `Float` to a `Word32`.</span><span>
</span><a name="line-57"></a><span class="hs-identifier">floatToWord</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Float</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Word32</span><span>
</span><a name="line-58"></a><a name="floatToWord"><a href="Data.FloatCast.html#floatToWord"><span class="hs-identifier">floatToWord</span></a></a><span> </span><a name="local-6989586621679026078"><a href="#local-6989586621679026078"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">runST</span><span> </span><span class="hs-special">(</span><a href="Data.FloatCast.html#cast"><span class="hs-identifier hs-var">cast</span></a><span> </span><a href="#local-6989586621679026078"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">)</span><span>
</span><a name="line-59"></a><span class="hs-pragma">{-# INLINE</span><span> </span><span class="hs-pragma">floatToWord</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-60"></a><span>
</span><a name="line-61"></a><span class="hs-comment">-- $setup</span><span>
</span><a name="line-62"></a><span class="hs-comment">-- &gt;&gt;&gt; import Numeric (showHex)</span><span>
</span><a name="line-63"></a><span class="hs-comment">-- &gt;&gt;&gt; import Data.Word</span><span>
</span><a name="line-64"></a><span>
</span><a name="line-65"></a><span class="hs-comment">-- | Reinterpret-casts a `Double` to a `Word64`.</span><span>
</span><a name="line-66"></a><span class="hs-comment">{-|
prop&gt; \f -&gt; wordToDouble (doubleToWord f ) == f

&gt;&gt;&gt; showHex (doubleToWord 1.0000000000000004) &quot;&quot;
&quot;3ff0000000000002&quot;

&gt;&gt;&gt; doubleToWord 1.0000000000000004 == 0x3FF0000000000002
True

&gt;&gt;&gt; showHex (doubleToWord (-0.15625)) &quot;&quot;
&quot;bfc4000000000000&quot;

&gt;&gt;&gt; wordToDouble 0xbfc4000000000000
-0.15625
-}</span><span>
</span><a name="line-81"></a><span class="hs-pragma">{-# INLINE</span><span> </span><span class="hs-pragma">doubleToWord</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-82"></a><span class="hs-identifier">doubleToWord</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Double</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Word64</span><span>
</span><a name="line-83"></a><a name="doubleToWord"><a href="Data.FloatCast.html#doubleToWord"><span class="hs-identifier">doubleToWord</span></a></a><span> </span><a name="local-6989586621679026079"><a href="#local-6989586621679026079"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">runST</span><span> </span><span class="hs-special">(</span><a href="Data.FloatCast.html#cast"><span class="hs-identifier hs-var">cast</span></a><span> </span><a href="#local-6989586621679026079"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">)</span><span>
</span><a name="line-84"></a><span class="hs-comment">-- doubleToWord x = fix64 $ runST (cast x)</span><span>
</span><a name="line-85"></a><span>
</span><a name="line-86"></a><span class="hs-comment">-- | Reinterpret-casts a `Word64` to a `Double`.</span><span>
</span><a name="line-87"></a><span class="hs-pragma">{-# INLINE</span><span> </span><span class="hs-pragma">wordToDouble</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-88"></a><span class="hs-identifier">wordToDouble</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Word64</span><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">Double</span><span>
</span><a name="line-89"></a><a name="wordToDouble"><a href="Data.FloatCast.html#wordToDouble"><span class="hs-identifier">wordToDouble</span></a></a><span> </span><a name="local-6989586621679026080"><a href="#local-6989586621679026080"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">runST</span><span> </span><span class="hs-special">(</span><a href="Data.FloatCast.html#cast"><span class="hs-identifier hs-var">cast</span></a><span> </span><a href="#local-6989586621679026080"><span class="hs-identifier hs-var">x</span></a><span class="hs-special">)</span><span>
</span><a name="line-90"></a><span class="hs-comment">-- wordToDouble x = runST (cast $ fix64 x)</span><span>
</span><a name="line-91"></a><span>
</span><a name="line-92"></a><span class="hs-comment">{- | 
&gt;&gt;&gt; runST (cast (0xF0F1F2F3F4F5F6F7::Word64)) == (0xF0F1F2F3F4F5F6F7::Word64)
True
-}</span><span>
</span><a name="line-96"></a><span class="hs-identifier">cast</span><span>
</span><a name="line-97"></a><span>  </span><span class="hs-glyph">::</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">MArray</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">STUArray</span><span> </span><a href="#local-6989586621679025207"><span class="hs-identifier hs-type">s</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679025208"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">ST</span><span> </span><a href="#local-6989586621679025207"><span class="hs-identifier hs-type">s</span></a><span class="hs-special">)</span><span class="hs-special">,</span><span> </span><span class="hs-identifier hs-type">MArray</span><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">STUArray</span><span> </span><a href="#local-6989586621679025207"><span class="hs-identifier hs-type">s</span></a><span class="hs-special">)</span><span> </span><a href="#local-6989586621679025209"><span class="hs-identifier hs-type">b</span></a><span> </span><span class="hs-special">(</span><span class="hs-identifier hs-type">ST</span><span> </span><a href="#local-6989586621679025207"><span class="hs-identifier hs-type">s</span></a><span class="hs-special">)</span><span class="hs-special">)</span><span> </span><span class="hs-glyph">=&gt;</span><span> </span><a href="#local-6989586621679025208"><span class="hs-identifier hs-type">a</span></a><span> </span><span class="hs-glyph">-&gt;</span><span> </span><span class="hs-identifier hs-type">ST</span><span> </span><a href="#local-6989586621679025207"><span class="hs-identifier hs-type">s</span></a><span> </span><a href="#local-6989586621679025209"><span class="hs-identifier hs-type">b</span></a><span>
</span><a name="line-98"></a><a name="cast"><a href="Data.FloatCast.html#cast"><span class="hs-identifier">cast</span></a></a><span> </span><a name="local-6989586621679026081"><a href="#local-6989586621679026081"><span class="hs-identifier">x</span></a></a><span> </span><span class="hs-glyph">=</span><span> </span><span class="hs-identifier hs-var">newArray</span><span> </span><span class="hs-special">(</span><span class="hs-number">0</span><span> </span><span class="hs-glyph">::</span><span> </span><span class="hs-identifier hs-type">Int</span><span class="hs-special">,</span><span> </span><span class="hs-number">0</span><span class="hs-special">)</span><span> </span><a href="#local-6989586621679026081"><span class="hs-identifier hs-var">x</span></a><span> </span><span class="hs-operator hs-var">&gt;&gt;=</span><span> </span><span class="hs-identifier hs-var">castSTUArray</span><span> </span><span class="hs-operator hs-var">&gt;&gt;=</span><span> </span><span class="hs-identifier hs-var">flip</span><span> </span><span class="hs-identifier hs-var">readArray</span><span> </span><span class="hs-number">0</span><span>
</span><a name="line-99"></a><span class="hs-pragma">{-# INLINE</span><span> </span><span class="hs-pragma">cast</span><span> </span><span class="hs-pragma">#-}</span><span>
</span><a name="line-100"></a><span>
</span><a name="line-101"></a><span class="hs-comment">-- Required for older versions of ghcjs</span><span>
</span><a name="line-102"></a><span class="hs-comment">-- #ifdef ghcjs_HOST_OS</span><span>
</span><a name="line-103"></a><span class="hs-comment">-- doubleToWord x = (`rotateR` 32) $ runST (cast x)</span><span>
</span><a name="line-104"></a><span class="hs-comment">-- #else</span><span>
</span><a name="line-105"></a><span class="hs-comment">-- doubleToWord x = runST (cast x)</span><span>
</span><a name="line-106"></a><span class="hs-comment">-- #endif</span><span>
</span><a name="line-107"></a><span class="hs-comment">-- #ifdef ghcjs_HOST_OS</span><span>
</span><a name="line-108"></a><span class="hs-comment">-- wordToDouble x = runST (cast $ x `rotateR` 32) </span><span>
</span><a name="line-109"></a><span class="hs-comment">-- #else</span><span>
</span><a name="line-110"></a><span class="hs-comment">-- wordToDouble x = runST (cast x) </span><span>
</span><a name="line-111"></a><span class="hs-comment">-- #endif</span><span>
</span><a name="line-112"></a></pre></body></html>